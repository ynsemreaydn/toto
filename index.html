<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kombinasyon Analizi - Maç Seçim ve Filtreleme</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        h2 {
            color: #667eea;
            margin: 30px 0 20px 0;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .matches-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .matches-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .matches-table th {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .matches-table td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .matches-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .matches-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .match-no {
            font-weight: bold;
            color: #667eea;
            background: #f0f0ff;
        }

        .match-date {
            font-weight: 600;
            color: #555;
        }

        .match-name {
            text-align: left !important;
            padding-left: 15px !important;
            font-weight: 500;
        }

        .percentage-cell {
            font-weight: bold;
            font-size: 1.1em;
        }

        .percentage-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }

        .percentage-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75em;
            font-weight: bold;
        }

        .selection-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .selection-table thead {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .selection-table th {
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .selection-table td {
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .selection-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .selection-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            align-items: center;
        }

        .selection-btn {
            padding: 8px 15px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            min-width: 50px;
        }

        .selection-btn:hover {
            transform: scale(1.05);
        }

        .selection-btn.selected-1 {
            background: #e74c3c;
            color: white;
            border-color: #c0392b;
        }

        .selection-btn.selected-0 {
            background: #f39c12;
            color: white;
            border-color: #e67e22;
        }

        .selection-btn.selected-2 {
            background: #27ae60;
            color: white;
            border-color: #229954;
        }

        .selection-btn:not(.selected-1):not(.selected-0):not(.selected-2) {
            background: #ecf0f1;
            color: #7f8c8d;
        }

        .coupon-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .coupon-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .coupon-stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .coupon-stat-label {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 10px;
        }

        .coupon-stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }

        .remaining-coupons {
            font-size: 1.3em;
            font-weight: bold;
            color: #27ae60;
            margin-top: 20px;
            padding: 15px;
            background: #d5f4e6;
            border-radius: 8px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        }

        .error {
            text-align: center;
            padding: 50px;
            color: #e74c3c;
            font-size: 1.2em;
        }

        .filter-info {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #856404;
        }

        /* Mobile Responsive Styles - Minimal adjustments only */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.4em;
            }

            .matches-table,
            .selection-table {
                font-size: 0.9em;
                overflow-x: auto;
                display: block;
            }

            .matches-table th,
            .selection-table th {
                padding: 10px 5px;
                font-size: 0.85em;
            }

            .matches-table td,
            .selection-table td {
                padding: 8px 5px;
                font-size: 0.85em;
            }

            .selection-btn {
                padding: 6px 10px;
                font-size: 0.9em;
                min-width: 40px;
            }

            .coupon-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kombinasyon Analizi ve Maç Seçim</h1>
        
        <h2>Maç Listesi ve Seçim Yüzdeleri</h2>
        <table class="matches-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Tarih</th>
                    <th>Saat</th>
                    <th>Karşılaşma</th>
                    <th>1 Seçimi</th>
                    <th>X Seçimi</th>
                    <th>2 Seçimi</th>
                </tr>
            </thead>
            <tbody id="matchesTableBody">
            </tbody>
        </table>

        <h2>Seçim Yap ve Filtrele</h2>
        <div class="filter-info" id="filterInfo">
            Henüz seçim yapılmadı. Her maç için 1, X veya 2 seçerek filtreleme yapabilirsiniz.
        </div>
        
        <table class="selection-table">
            <thead>
                <tr>
                    <th>Maç No</th>
                    <th>Karşılaşma</th>
                    <th>Seçim</th>
                    <th>Kalan Kupon</th>
                </tr>
            </thead>
            <tbody id="selectionTableBody">
            </tbody>
        </table>

        <div class="coupon-stats">
            <h2>Kupon İstatistikleri</h2>
            <div class="remaining-coupons" id="remainingCoupons">
                Toplam Kupon: <span id="totalCoupons">0</span>
            </div>
            <div class="coupon-stats-grid">
                <div class="coupon-stat-card">
                    <div class="coupon-stat-label">15 Bilen</div>
                    <div class="coupon-stat-value" id="count15">0</div>
                </div>
                <div class="coupon-stat-card">
                    <div class="coupon-stat-label">14 Bilen</div>
                    <div class="coupon-stat-value" id="count14">0</div>
                </div>
                <div class="coupon-stat-card">
                    <div class="coupon-stat-label">13 Bilen</div>
                    <div class="coupon-stat-value" id="count13">0</div>
                </div>
                <div class="coupon-stat-card">
                    <div class="coupon-stat-label">12 Bilen</div>
                    <div class="coupon-stat-value" id="count12">0</div>
                </div>
            </div>
        </div>
    </div>

        <script>
        // Kombinasyonlar combinations_latest_fetched.csv dosyasından yüklenir (fetch ile)

        // Maç verileri doğrudan embed edildi
        const matchesData = [
          {
            "no": 1,
            "tarih": "27.02.2026 20:00",
            "karsilasma": "Başakşehir FK-Konyaspor",
            "oran_1": 0.0,
            "oran_x": 0.0,
            "oran_2": 1.0,
            "comb_1_count": 0,
            "comb_1_pct": 0.0,
            "comb_0_count": 0,
            "comb_0_pct": 0.0,
            "comb_2_count": 15,
            "comb_2_pct": 100.0
          },
          {
            "no": 2,
            "tarih": "27.02.2026 20:00",
            "karsilasma": "Trabzonspor A.Ş.-Fatih Karagümrük",
            "oran_1": 0.7333,
            "oran_x": 0.0,
            "oran_2": 0.2667,
            "comb_1_count": 11,
            "comb_1_pct": 73.33,
            "comb_0_count": 0,
            "comb_0_pct": 0.0,
            "comb_2_count": 4,
            "comb_2_pct": 26.67
          },
          {
            "no": 3,
            "tarih": "28.02.2026 13:30",
            "karsilasma": "Kasımpaşa A.Ş.-Çaykur Rizespor A.Ş.",
            "oran_1": 0.5333,
            "oran_x": 0.4667,
            "oran_2": 0.0,
            "comb_1_count": 8,
            "comb_1_pct": 53.33,
            "comb_0_count": 7,
            "comb_0_pct": 46.67,
            "comb_2_count": 0,
            "comb_2_pct": 0.0
          },
          {
            "no": 4,
            "tarih": "28.02.2026 16:00",
            "karsilasma": "Kocaelispor-Beşiktaş A.Ş.",
            "oran_1": 0.6667,
            "oran_x": 0.3333,
            "oran_2": 0.0,
            "comb_1_count": 10,
            "comb_1_pct": 66.67,
            "comb_0_count": 5,
            "comb_0_pct": 33.33,
            "comb_2_count": 0,
            "comb_2_pct": 0.0
          },
          {
            "no": 5,
            "tarih": "28.02.2026 20:00",
            "karsilasma": "Galatasaray A.Ş.-Alanyaspor",
            "oran_1": 0.8667,
            "oran_x": 0.1333,
            "oran_2": 0.0,
            "comb_1_count": 13,
            "comb_1_pct": 86.67,
            "comb_0_count": 2,
            "comb_0_pct": 13.33,
            "comb_2_count": 0,
            "comb_2_pct": 0.0
          },
          {
            "no": 6,
            "tarih": "28.02.2026 20:00",
            "karsilasma": "Göztepe A.Ş.-Eyüpspor",
            "oran_1": 1.0,
            "oran_x": 0.0,
            "oran_2": 0.0,
            "comb_1_count": 15,
            "comb_1_pct": 100.0,
            "comb_0_count": 0,
            "comb_0_pct": 0.0,
            "comb_2_count": 0,
            "comb_2_pct": 0.0
          },
          {
            "no": 7,
            "tarih": "01.03.2026 16:00",
            "karsilasma": "Gençlerbirliği-Kayserispor",
            "oran_1": 0.2667,
            "oran_x": 0.3333,
            "oran_2": 0.4,
            "comb_1_count": 4,
            "comb_1_pct": 26.67,
            "comb_0_count": 5,
            "comb_0_pct": 33.33,
            "comb_2_count": 6,
            "comb_2_pct": 40.0
          },
          {
            "no": 8,
            "tarih": "01.03.2026 20:00",
            "karsilasma": "Antalyaspor-Fenerbahçe A.Ş.",
            "oran_1": 1.0,
            "oran_x": 0.0,
            "oran_2": 0.0,
            "comb_1_count": 15,
            "comb_1_pct": 100.0,
            "comb_0_count": 0,
            "comb_0_pct": 0.0,
            "comb_2_count": 0,
            "comb_2_pct": 0.0
          },
          {
            "no": 9,
            "tarih": "01.03.2026 20:00",
            "karsilasma": "Samsunspor A.Ş.-Gaziantep F.K. A.Ş.",
            "oran_1": 0.0,
            "oran_x": 0.0,
            "oran_2": 1.0,
            "comb_1_count": 0,
            "comb_1_pct": 0.0,
            "comb_0_count": 0,
            "comb_0_pct": 0.0,
            "comb_2_count": 15,
            "comb_2_pct": 100.0
          },
          {
            "no": 10,
            "tarih": "28.02.2026 20:30",
            "karsilasma": "B. Dortmund-Bayern Münih",
            "oran_1": 0.0667,
            "oran_x": 0.0,
            "oran_2": 0.9333,
            "comb_1_count": 1,
            "comb_1_pct": 6.67,
            "comb_0_count": 0,
            "comb_0_pct": 0.0,
            "comb_2_count": 14,
            "comb_2_pct": 93.33
          },
          {
            "no": 11,
            "tarih": "01.03.2026 19:30",
            "karsilasma": "Eintracht Frankfurt-Freiburg",
            "oran_1": 1.0,
            "oran_x": 0.0,
            "oran_2": 0.0,
            "comb_1_count": 15,
            "comb_1_pct": 100.0,
            "comb_0_count": 0,
            "comb_0_pct": 0.0,
            "comb_2_count": 0,
            "comb_2_pct": 0.0
          },
          {
            "no": 12,
            "tarih": "28.02.2026 15:30",
            "karsilasma": "Bournemouth-Sunderland",
            "oran_1": 0.4667,
            "oran_x": 0.3333,
            "oran_2": 0.2,
            "comb_1_count": 7,
            "comb_1_pct": 46.67,
            "comb_0_count": 5,
            "comb_0_pct": 33.33,
            "comb_2_count": 3,
            "comb_2_pct": 20.0
          },
          {
            "no": 13,
            "tarih": "28.02.2026 18:00",
            "karsilasma": "Newcastle United-Everton",
            "oran_1": 0.0,
            "oran_x": 0.0,
            "oran_2": 1.0,
            "comb_1_count": 0,
            "comb_1_pct": 0.0,
            "comb_0_count": 0,
            "comb_0_pct": 0.0,
            "comb_2_count": 15,
            "comb_2_pct": 100.0
          },
          {
            "no": 14,
            "tarih": "01.03.2026 19:30",
            "karsilasma": "Arsenal-Chelsea",
            "oran_1": 0.7333,
            "oran_x": 0.2,
            "oran_2": 0.0667,
            "comb_1_count": 11,
            "comb_1_pct": 73.33,
            "comb_0_count": 3,
            "comb_0_pct": 20.0,
            "comb_2_count": 1,
            "comb_2_pct": 6.67
          },
          {
            "no": 15,
            "tarih": "28.02.2026 18:15",
            "karsilasma": "Barcelona-Villarreal",
            "oran_1": 0.4667,
            "oran_x": 0.4,
            "oran_2": 0.1333,
            "comb_1_count": 7,
            "comb_1_pct": 46.67,
            "comb_0_count": 6,
            "comb_0_pct": 40.0,
            "comb_2_count": 2,
            "comb_2_pct": 13.33
          }
        ];

        let combinations = [];
        let selections = {}; // {matchNo: 1|0|2|null}
        let filteredCombinations = [];
        
        // Sabit seçimler: 1. maç = 0, 2. maç = 2 (değiştirilemez)
        const fixedSelections = { 1: 0, 2: 2 };

        function renderMatchesTable() {
            const tbody = document.getElementById('matchesTableBody');
            tbody.innerHTML = '';
            
            matchesData.forEach(match => {
                const tr = document.createElement('tr');
                
                // No
                const tdNo = document.createElement('td');
                tdNo.className = 'match-no';
                tdNo.textContent = match.no;
                tdNo.setAttribute('data-label', 'No');
                tr.appendChild(tdNo);
                
                // Tarih ve Saat
                const dateTime = match.tarih.split(' ');
                const tdDate = document.createElement('td');
                tdDate.className = 'match-date';
                tdDate.textContent = dateTime[0] || '';
                tdDate.setAttribute('data-label', 'Tarih');
                tr.appendChild(tdDate);
                
                const tdTime = document.createElement('td');
                tdTime.className = 'match-date';
                tdTime.textContent = dateTime[1] || '';
                tdTime.setAttribute('data-label', 'Saat');
                tr.appendChild(tdTime);
                
                // Karşılaşma
                const tdMatch = document.createElement('td');
                tdMatch.className = 'match-name';
                tdMatch.textContent = match.karsilasma;
                tdMatch.setAttribute('data-label', 'Karşılaşma');
                tr.appendChild(tdMatch);
                
                // 1 Seçimi
                const td1 = document.createElement('td');
                td1.className = 'percentage-cell';
                td1.setAttribute('data-label', '1 Seçimi');
                td1.innerHTML = `
                    ${match.comb_1_pct.toFixed(2)}% (${match.comb_1_count})
                    <div class="percentage-bar">
                        <div class="percentage-fill" style="width: ${match.comb_1_pct}%">
                            ${match.comb_1_pct >= 5 ? match.comb_1_pct.toFixed(1) + '%' : ''}
                        </div>
                    </div>
                `;
                tr.appendChild(td1);
                
                // X Seçimi
                const tdX = document.createElement('td');
                tdX.className = 'percentage-cell';
                tdX.setAttribute('data-label', 'X Seçimi');
                tdX.innerHTML = `
                    ${match.comb_0_pct.toFixed(2)}% (${match.comb_0_count})
                    <div class="percentage-bar">
                        <div class="percentage-fill" style="width: ${match.comb_0_pct}%">
                            ${match.comb_0_pct >= 5 ? match.comb_0_pct.toFixed(1) + '%' : ''}
                        </div>
                    </div>
                `;
                tr.appendChild(tdX);
                
                // 2 Seçimi
                const td2 = document.createElement('td');
                td2.className = 'percentage-cell';
                td2.setAttribute('data-label', '2 Seçimi');
                td2.innerHTML = `
                    ${match.comb_2_pct.toFixed(2)}% (${match.comb_2_count})
                    <div class="percentage-bar">
                        <div class="percentage-fill" style="width: ${match.comb_2_pct}%">
                            ${match.comb_2_pct >= 5 ? match.comb_2_pct.toFixed(1) + '%' : ''}
                        </div>
                    </div>
                `;
                tr.appendChild(td2);
                
                tbody.appendChild(tr);
            });
        }

        function renderSelectionTable() {
            const tbody = document.getElementById('selectionTableBody');
            tbody.innerHTML = '';
            
            matchesData.forEach(match => {
                const tr = document.createElement('tr');
                
                // Maç No
                const tdNo = document.createElement('td');
                tdNo.className = 'match-no';
                tdNo.textContent = match.no;
                tdNo.setAttribute('data-label', 'Maç No');
                tr.appendChild(tdNo);
                
                // Karşılaşma
                const tdMatch = document.createElement('td');
                tdMatch.className = 'match-name';
                tdMatch.textContent = match.karsilasma;
                tdMatch.setAttribute('data-label', 'Karşılaşma');
                tr.appendChild(tdMatch);
                
                // Seçim Butonları
                const tdSelection = document.createElement('td');
                tdSelection.className = 'selection-buttons';
                tdSelection.setAttribute('data-label', 'Seçim');
                
                // Sabit seçimler için kontrol
                const isFixed = fixedSelections.hasOwnProperty(match.no);
                const fixedValue = isFixed ? fixedSelections[match.no] : null;
                
                const btn1 = document.createElement('button');
                btn1.className = 'selection-btn';
                btn1.textContent = '1';
                if (isFixed) {
                    btn1.disabled = true;
                    btn1.style.opacity = '0.5';
                    btn1.style.cursor = 'not-allowed';
                } else {
                    btn1.onclick = () => toggleSelection(match.no, 1);
                }
                if (selections[match.no] === 1 || fixedValue === 1) {
                    btn1.classList.add('selected-1');
                }
                tdSelection.appendChild(btn1);
                
                const btn0 = document.createElement('button');
                btn0.className = 'selection-btn';
                btn0.textContent = 'X';
                if (isFixed) {
                    btn0.disabled = true;
                    btn0.style.opacity = '0.5';
                    btn0.style.cursor = 'not-allowed';
                } else {
                    btn0.onclick = () => toggleSelection(match.no, 0);
                }
                if (selections[match.no] === 0 || fixedValue === 0) {
                    btn0.classList.add('selected-0');
                }
                tdSelection.appendChild(btn0);
                
                const btn2 = document.createElement('button');
                btn2.className = 'selection-btn';
                btn2.textContent = '2';
                if (isFixed) {
                    btn2.disabled = true;
                    btn2.style.opacity = '0.5';
                    btn2.style.cursor = 'not-allowed';
                } else {
                    btn2.onclick = () => toggleSelection(match.no, 2);
                }
                if (selections[match.no] === 2 || fixedValue === 2) {
                    btn2.classList.add('selected-2');
                }
                tdSelection.appendChild(btn2);
                
                tr.appendChild(tdSelection);
                
                // Kalan Kupon (dinamik olarak güncellenecek)
                const tdRemaining = document.createElement('td');
                tdRemaining.id = `remaining-${match.no}`;
                tdRemaining.style.fontWeight = 'bold';
                tdRemaining.style.fontSize = '1.1em';
                tdRemaining.setAttribute('data-label', 'Kalan Kupon');
                tdRemaining.textContent = combinations.length;
                tr.appendChild(tdRemaining);
                
                tbody.appendChild(tr);
            });
        }

        function toggleSelection(matchNo, value) {
            // Sabit seçimler değiştirilemez
            if (fixedSelections.hasOwnProperty(matchNo)) {
                return;
            }
            
            if (selections[matchNo] === value) {
                // Aynı seçimi tekrar tıklarsa seçimi kaldır
                delete selections[matchNo];
            } else {
                selections[matchNo] = value;
            }
            
            filterCombinations();
            renderSelectionTable();
            updateStats();
            updateRemainingCounts();
        }

        function filterCombinations() {
            // Sabit seçimleri de dahil et
            const allSelections = Object.assign({}, fixedSelections, selections);
            
            filteredCombinations = combinations.filter(comb => {
                for (let matchNo in allSelections) {
                    const matchIndex = parseInt(matchNo) - 1; // Maç no 1-15, index 0-14
                    if (comb.values[matchIndex] !== allSelections[matchNo]) {
                        return false;
                    }
                }
                return true;
            });
        }

        function updateRemainingCounts() {
            matchesData.forEach(match => {
                const remainingElement = document.getElementById(`remaining-${match.no}`);
                if (!remainingElement) return;
                
                // 1. ve 2. maç için: Her zaman toplam kupon sayısını göster
                if (match.no === 1 || match.no === 2) {
                    remainingElement.textContent = combinations.length;
                    return;
                }
                
                // 3-15 arası maçlar için:
                // 1. maça bakma (herhangi bir değer olabilir), 2. maça bak (2 olmalı), kullanıcı seçimlerine bak
                const userSelections = {};
                for (let matchNo in selections) {
                    const matchNum = parseInt(matchNo);
                    // Sadece 3-15 arası maçları dahil et
                    if (matchNum >= 3 && matchNum <= 15) {
                        userSelections[matchNum] = selections[matchNum];
                    }
                }
                
                if (selections[match.no] !== undefined) {
                    // Kullanıcı seçimi var - 2. maça bak (2 olmalı) ve kullanıcı seçimlerine göre filtrele (1. maça bakma)
                    const count = combinations.filter(comb => {
                        // 2. maç = 2 olmalı (index 1)
                        if (comb.values[1] !== 2) {
                            return false;
                        }
                        // 3-15 arası maçlardaki kullanıcı seçimlerine göre kontrol et
                        for (let matchNo in userSelections) {
                            const matchIndex = parseInt(matchNo) - 1; // Maç no 1-15, index 0-14
                            if (comb.values[matchIndex] !== userSelections[matchNo]) {
                                return false;
                            }
                        }
                        return true;
                    }).length;
                    remainingElement.textContent = count;
                } else {
                    // Kullanıcı seçimi yok - 2. maça bak (2 olmalı) ve bu maçın her seçeneği için topla (1. maça bakma)
                    let totalCount = 0;
                    
                    // Bu maçın her seçeneği (0, 1, 2) için say
                    for (let option of [0, 1, 2]) {
                        const tempSelections = Object.assign({}, userSelections, { [match.no]: option });
                        const count = combinations.filter(comb => {
                            // 2. maç = 2 olmalı (index 1)
                            if (comb.values[1] !== 2) {
                                return false;
                            }
                            // 3-15 arası maçlardaki seçimlere göre kontrol et
                            for (let matchNo in tempSelections) {
                                const matchIndex = parseInt(matchNo) - 1;
                                if (comb.values[matchIndex] !== tempSelections[matchNo]) {
                                    return false;
                                }
                            }
                            return true;
                        }).length;
                        totalCount += count;
                    }
                    remainingElement.textContent = totalCount;
                }
            });
        }

        function updateStats() {
            // Sabit seçimleri de dahil et
            const allSelections = Object.assign({}, fixedSelections, selections);
            const selectedMatchesCount = Object.keys(allSelections).length;
            const totalCombinations = combinations.length;
            const counts = { 15: 0, 14: 0, 13: 0, 12: 0 };
            
            // Kalan kupon sayısı = filtrelenmiş kombinasyonlar
            const totalCoupons = filteredCombinations.length;
            document.getElementById('totalCoupons').textContent = totalCoupons;
            
            if (selectedMatchesCount === 0) {
                // Hiçbir seçim yok (sabit seçimler de yok - bu durum olmamalı ama yine de)
                counts[15] = totalCombinations;
                counts[14] = totalCombinations;
                counts[13] = totalCombinations;
                counts[12] = totalCombinations;
            } else {
                // Seçimler var - filtrelenmiş kombinasyonlar var
                if (filteredCombinations.length === 0) {
                    // Hiçbir kupon eşleşmiyor - seçilen maçlar yanlış
                    // Bu durumda daha düşük bilen sayıları tüm kombinasyonları içerir
                    const correctCount = 15 - selectedMatchesCount;
                    
                    if (correctCount >= 14) {
                        counts[14] = totalCombinations;
                        counts[13] = totalCombinations;
                        counts[12] = totalCombinations;
                    } else if (correctCount === 13) {
                        counts[13] = totalCombinations;
                        counts[12] = totalCombinations;
                    } else if (correctCount === 12) {
                        counts[12] = totalCombinations;
                    }
                    counts[15] = 0;
                } else {
                    // Filtrelenmiş kombinasyonlar var
                    // Seçilen maç sayısına göre bilen sayılarını ayarla
                    if (selectedMatchesCount === 15) {
                        // 15 maç seçilmiş - 15 bilen = filtrelenmiş kombinasyonlar
                        counts[15] = filteredCombinations.length;
                    } else if (selectedMatchesCount === 14) {
                        // 14 maç seçilmiş - 14 bilen = filtrelenmiş kombinasyonlar
                        // 13 ve 12 bilen = tüm kombinasyonlar (çünkü 13 veya 12 doğru olabilir)
                        counts[14] = filteredCombinations.length;
                        counts[13] = totalCombinations;
                        counts[12] = totalCombinations;
                    } else if (selectedMatchesCount === 13) {
                        // 13 maç seçilmiş - 13 bilen = filtrelenmiş kombinasyonlar
                        // 12 bilen = tüm kombinasyonlar
                        counts[13] = filteredCombinations.length;
                        counts[12] = totalCombinations;
                    } else if (selectedMatchesCount === 12) {
                        // 12 maç seçilmiş - 12 bilen = filtrelenmiş kombinasyonlar
                        counts[12] = filteredCombinations.length;
                    } else if (selectedMatchesCount < 12) {
                        // 12'den az maç seçilmiş - 12 bilen = filtrelenmiş kombinasyonlar
                        // 13 ve 14 bilen = tüm kombinasyonlar (çünkü 13 veya 14 doğru olabilir)
                        counts[12] = filteredCombinations.length;
                        counts[13] = totalCombinations;
                        counts[14] = totalCombinations;
                    }
                }
            }
            
            document.getElementById('count15').textContent = counts[15];
            document.getElementById('count14').textContent = counts[14];
            document.getElementById('count13').textContent = counts[13];
            document.getElementById('count12').textContent = counts[12];
            
            // Filtre bilgisi
            const userSelectedCount = Object.keys(selections).length;
            const totalSelectedCount = Object.keys(allSelections).length;
            if (userSelectedCount === 0) {
                document.getElementById('filterInfo').textContent = 
                    `${totalSelectedCount} maç sabit seçim (1. maç=0, 2. maç=2). ${filteredCombinations.length} kupon kaldı.`;
                document.getElementById('filterInfo').style.background = '#d1ecf1';
                document.getElementById('filterInfo').style.borderColor = '#0c5460';
            } else {
                document.getElementById('filterInfo').textContent = 
                    `${totalSelectedCount} maç için seçim yapıldı. ${filteredCombinations.length} kupon kaldı.`;
                document.getElementById('filterInfo').style.background = '#d1ecf1';
                document.getElementById('filterInfo').style.borderColor = '#0c5460';
            }
        }

        async function loadData() {
            try {
                // Kombinasyonlar combinations_latest_fetched.csv dosyasından yüklenir
                const csvUrl = 'combinations_latest_fetched.csv';
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`CSV yüklenemedi: ${response.status} ${response.statusText}`);
                const text = await response.text();
                const lines = text.trim().split(/\r?\n/).filter(line => line.length > 0);
                if (lines.length < 2) throw new Error('CSV dosyasında veri satırı yok');

                // İlk satır: maç adları (1 - Karşılaşma;2 - Karşılaşma;...) veya sayısal başlık (1;2;3;...;15)
                const firstLine = lines[0];
                let dataStartIndex = 1;
                if (firstLine.indexOf(' - ') !== -1) {
                    // Maç adları satırı: her hücre "N - Karşılaşma" formatında
                    const cells = firstLine.split(';');
                    for (let i = 0; i < cells.length && i < matchesData.length; i++) {
                        const cell = cells[i].trim();
                        const dashIdx = cell.indexOf(' - ');
                        matchesData[i].karsilasma = dashIdx >= 0 ? cell.substring(dashIdx + 3).trim() : cell;
                    }
                    dataStartIndex = 2; // Veri satırları 3. satırdan itibaren (2. satır 1;2;3;...;15)
                }

                const dataLines = lines.slice(dataStartIndex);
                combinations = dataLines.map((line, index) => {
                    const values = line.split(';').slice(0, 15).map(s => parseInt(s, 10));
                    if (values.length !== 15 || values.some(n => isNaN(n))) return null;
                    return { id: index + 1, values };
                }).filter(Boolean);

                // Sabit seçimleri ekle
                Object.assign(selections, fixedSelections);
                
                // Sabit seçimlere göre filtrele
                filterCombinations();
                
                renderMatchesTable();
                renderSelectionTable();
                updateStats();
                updateRemainingCounts();
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `<h2>Hata: ${error.message}</h2><p>combinations_latest_fetched.csv dosyasının sayfa ile aynı dizinde olduğundan emin olun (örn. GitHub Pages).</p>`;
                document.body.innerHTML = '';
                document.body.appendChild(errorDiv);
            }
        }

        // Sayfa yüklendiğinde verileri yükle
        loadData();
    </script>
</body>
</html>